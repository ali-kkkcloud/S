<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management Portal - Real-time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 400px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-demo {
            background: linear-gradient(45deg, #48bb78, #38a169);
            font-size: 14px;
            padding: 10px 20px;
            margin: 5px;
            width: auto;
            display: inline-block;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: #f8fafc;
        }

        .dashboard.show {
            display: block;
        }

        .header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c53030;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .nav-tab {
            background: transparent;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f7fafc;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2, .card h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            font-weight: 600;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }

        .status-working { background: #c6f6d5; color: #22543d; }
        .status-break { background: #fef5e7; color: #975a16; }
        .status-out { background: #fed7d7; color: #742a2a; }
        .status-present { background: #c6f6d5; color: #22543d; }
        .status-absent { background: #fed7d7; color: #742a2a; }

        /* Time Display */
        .time-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .time-item h4 {
            color: #718096;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .time-item span {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
            font-size: 14px;
            padding: 10px;
            margin-bottom: 0;
        }

        .btn-success { 
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        .btn-danger { 
            background: linear-gradient(45deg, #e53e3e, #c53030);
        }
        .btn-warning { 
            background: linear-gradient(45deg, #ed8936, #dd6b20);
        }
        .btn-info {
            background: linear-gradient(45deg, #4299e1, #3182ce);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin: 2px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* Task Items */
        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .task-item:hover {
            border-color: #667eea;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #718096;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-high { color: #e53e3e; font-weight: bold; }
        .priority-medium { color: #ed8936; font-weight: bold; }
        .priority-low { color: #48bb78; font-weight: bold; }

        /* Employee Cards */
        .employee-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .employee-info h4 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .employee-info p {
            color: #718096;
            font-size: 14px;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2d3748;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: #f7fafc;
        }

        /* Form Styling */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row .input-group {
            margin-bottom: 15px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .notification.success { 
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        .notification.error { 
            background: linear-gradient(45deg, #e53e3e, #c53030);
        }
        .notification.info { 
            background: linear-gradient(45deg, #4299e1, #3182ce);
        }

        /* Live Status Indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #48bb78;
            font-size: 12px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Real-time Status */
        .realtime-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }

        .realtime-status.active {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { 
                padding: 10px; 
            }
            
            .grid { 
                grid-template-columns: 1fr; 
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header { 
                flex-direction: column; 
                gap: 15px; 
                text-align: center; 
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .action-buttons { 
                flex-direction: column; 
            }
            
            .time-display { 
                grid-template-columns: repeat(2, 1fr);
            }
            
            .employee-card {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .task-header {
                flex-direction: column;
                align-items: start;
                gap: 10px;
            }

            .task-meta {
                flex-direction: column;
                align-items: start;
                gap: 5px;
            }
        }

        @media (max-width: 600px) {
            .login-box {
                width: 90%;
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Real-time Status Indicator -->
    <div id="realtimeStatus" class="realtime-status">
        <div class="live-dot"></div>
        <span>Connecting...</span>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <h1>üè¢ Employee Portal</h1>
            <p style="margin-bottom: 20px; color: #666; font-size: 14px;">‚ö° Real-time Database System</p>
            <form id="loginForm">
                <div class="input-group">
                    <label>üìß Email</label>
                    <input type="email" id="email" required placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label>üîê Password</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn">
                    <span id="loginBtnText">Login</span>
                    <span id="loginLoader" class="loading" style="display: none;"></span>
                </button>
            </form>
            
            <div style="margin-top: 20px;">
                <p style="margin-bottom: 10px; color: #666;">Quick Demo Access:</p>
                <button class="btn btn-demo" onclick="demoLogin('admin')">üë®‚Äçüíº Admin (Real-time Mode)</button>
                <button class="btn btn-demo" onclick="demoLogin('employee')">üë§ Employee (Real-time Mode)</button>
                <p style="font-size: 11px; color: #888; margin-top: 10px;">
                    ‚ö° All changes sync in real-time across all devices
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1>Welcome, <span id="userName">User</span></h1>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span id="connectionStatus" onclick="checkDatabaseConnection()" style="cursor: pointer; text-decoration: underline;" title="Click to test connection">Connecting...</span>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-badge" id="userRole">Employee</span>
                    <span id="userEmail">user@example.com</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs" id="navTabs">
                <!-- Tabs will be dynamically generated based on user role -->
            </div>

            <!-- Tab Contents -->
            
            <!-- Employee Dashboard Tab -->
            <div id="employeeDashboard" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todayHours">0h 0m</div>
                        <div class="stat-label">Today's Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisWeekHours">0h 0m</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Active Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="leaveBalance">15</div>
                        <div class="stat-label">Leave Balance</div>
                    </div>
                </div>

                <div class="grid">
                    <!-- Attendance Card -->
                    <div class="card">
                        <h2>
                            <div class="card-icon">‚è∞</div>
                            Attendance
                        </h2>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <span id="attendanceStatus" class="status-badge status-out">Not Checked In</span>
                        </div>
                        
                        <div class="time-display">
                            <div class="time-item">
                                <h4>Check In</h4>
                                <span id="checkInTime">--:--</span>
                            </div>
                            <div class="time-item">
                                <h4>Working</h4>
                                <span id="workingTime">0h 0m</span>
                            </div>
                            <div class="time-item">
                                <h4>Break</h4>
                                <span id="breakTime">0h 0m</span>
                            </div>
                            <div class="time-item">
                                <h4>Check Out</h4>
                                <span id="checkOutTime">--:--</span>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="checkInBtn" class="btn btn-success" onclick="checkIn()">Check In</button>
                            <button id="checkOutBtn" class="btn btn-danger" onclick="checkOut()" disabled>Check Out</button>
                            <button id="breakBtn" class="btn btn-warning" onclick="toggleBreak()" disabled>Break</button>
                        </div>
                    </div>

                    <!-- My Tasks Card -->
                    <div class="card">
                        <h2>
                            <div class="card-icon">üìã</div>
                            My Tasks
                        </h2>
                        <div id="myTaskList" class="task-list">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>

                    <!-- My Schedule Card -->
                    <div class="card">
                        <h2>
                            <div class="card-icon">üìÖ</div>
                            My Schedule
                        </h2>
                        <div id="mySchedule">
                            <!-- Schedule will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard Tab -->
            <div id="adminDashboard" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalEmployees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="presentToday">0</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="absentToday">0</div>
                        <div class="stat-label">Absent Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="onBreak">0</div>
                        <div class="stat-label">On Break</div>
                    </div>
                </div>

                <div class="grid">
                    <!-- Live Attendance Card -->
                    <div class="card">
                        <h2>
                            <div class="card-icon">üë•</div>
                            Live Attendance
                        </h2>
                        <div id="liveAttendance">
                            <!-- Live attendance will be loaded here -->
                        </div>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="card">
                        <h2>
                            <div class="card-icon">‚ö°</div>
                            Quick Actions
                        </h2>
                        <div style="display: grid; gap: 10px;">
                            <button class="btn btn-info" onclick="openAddEmployeeModal()">‚ûï Add Employee</button>
                            <button class="btn btn-info" onclick="openAddTaskModal()">üìù Assign Task</button>
                            <button class="btn btn-info" onclick="openCreateRosterModal()">üìÖ Create Roster</button>
                            <button class="btn btn-info" onclick="exportAttendance()">üìä Export Reports</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee Management Tab -->
            <div id="employeeManagement" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>üë• Employee Management</h2>
                    <button class="btn btn-info" onclick="openAddEmployeeModal()">‚ûï Add Employee</button>
                </div>
                <div id="employeeList">
                    <!-- Employee list will be loaded here -->
                </div>
            </div>

            <!-- Attendance Reports Tab -->
            <div id="attendanceReports" class="tab-content">
                <div class="card">
                    <h2>
                        <div class="card-icon">üìä</div>
                        Attendance Reports
                    </h2>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <label>Select Month:</label>
                        <input type="month" id="reportMonth" value="" onchange="loadAttendanceReport()" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-info" onclick="exportAttendanceReport()">üì• Export</button>
                    </div>
                    <div id="attendanceReportData">
                        <!-- Report data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Task Management Tab -->
            <div id="taskManagement" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>üìã Task Management</h2>
                    <button class="btn btn-info" onclick="openAddTaskModal()">‚ûï Assign Task</button>
                </div>
                <div id="allTasksList">
                    <!-- All tasks will be loaded here -->
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div id="leaveManagement" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>üèñÔ∏è Leave Management</h2>
                    <button class="btn btn-info" onclick="openApplyLeaveModal()">‚ûï Apply Leave</button>
                </div>
                <div id="leaveRequestsList">
                    <!-- Leave requests will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Add New Employee</h3>
                <button class="close" onclick="closeModal('addEmployeeModal')">&times;</button>
            </div>
            <form id="addEmployeeForm">
                <div class="form-row">
                    <div class="input-group">
                        <label>üë§ Full Name</label>
                        <input type="text" id="empName" placeholder="John Doe" required>
                    </div>
                    <div class="input-group">
                        <label>üìß Email</label>
                        <input type="email" id="empEmail" placeholder="john@company.com" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>üìû Phone</label>
                        <input type="text" id="empPhone" placeholder="+91 9876543210">
                    </div>
                    <div class="input-group">
                        <label>üè¢ Department</label>
                        <select id="empDepartment">
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>üëë Role</label>
                        <select id="empRole">
                            <option value="employee">Employee</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üí∞ Salary</label>
                        <input type="number" id="empSalary" placeholder="50000">
                    </div>
                </div>
                <div class="input-group">
                    <label>üìÖ Join Date</label>
                    <input type="date" id="empJoinDate">
                </div>
                <button type="submit" class="btn">Add Employee</button>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Assign New Task</h3>
                <button class="close" onclick="closeModal('addTaskModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="input-group">
                    <label>üë§ Assign To</label>
                    <select id="taskAssignTo" required>
                        <option value="">Select Employee</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="input-group">
                    <label>üìã Task Title</label>
                    <input type="text" id="taskTitle" required placeholder="Complete project documentation">
                </div>
                <div class="input-group">
                    <label>üìù Description</label>
                    <textarea id="taskDescription" rows="3" placeholder="Detailed task description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>‚ö° Priority</label>
                        <select id="taskPriority" required>
                            <option value="low">üü¢ Low</option>
                            <option value="medium" selected>üü° Medium</option>
                            <option value="high">üî¥ High</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üìÖ Due Date</label>
                        <input type="date" id="taskDueDate" required>
                    </div>
                </div>
                <button type="submit" class="btn">Assign Task</button>
            </form>
        </div>
    </div>

    <!-- Create Roster Modal -->
    <div id="createRosterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÖ Create Roster</h3>
                <button class="close" onclick="closeModal('createRosterModal')">&times;</button>
            </div>
            <form id="createRosterForm">
                <div class="form-row">
                    <div class="input-group">
                        <label>üë§ Employee</label>
                        <select id="rosterEmployee" required>
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üìÖ Date</label>
                        <input type="date" id="rosterDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>üïê Shift</label>
                        <select id="rosterShift" required>
                            <option value="">Select Shift</option>
                            <option value="morning">üåÖ Morning (9 AM - 6 PM)</option>
                            <option value="evening">üåÜ Evening (2 PM - 11 PM)</option>
                            <option value="night">üåô Night (11 PM - 8 AM)</option>
                            <option value="half">üïê Half Day (9 AM - 1 PM)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üìç Location</label>
                        <select id="rosterLocation">
                            <option value="office">üè¢ Office</option>
                            <option value="remote">üè† Remote</option>
                            <option value="hybrid">üîÑ Hybrid</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>üìù Notes</label>
                    <textarea id="rosterNotes" rows="2" placeholder="Special instructions or notes..."></textarea>
                </div>
                <button type="submit" class="btn">Create Roster Entry</button>
            </form>
        </div>
    </div>

    <!-- Apply Leave Modal -->
    <div id="applyLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üèñÔ∏è Apply for Leave</h3>
                <button class="close" onclick="closeModal('applyLeaveModal')">&times;</button>
            </div>
            <form id="applyLeaveForm">
                <div class="form-row">
                    <div class="input-group">
                        <label>üìÖ From Date</label>
                        <input type="date" id="leaveFromDate" required>
                    </div>
                    <div class="input-group">
                        <label>üìÖ To Date</label>
                        <input type="date" id="leaveToDate" required>
                    </div>
                </div>
                <div class="input-group">
                    <label>üè∑Ô∏è Leave Type</label>
                    <select id="leaveType" required>
                        <option value="">Select Leave Type</option>
                        <option value="casual">Casual Leave</option>
                        <option value="sick">Sick Leave</option>
                        <option value="earned">Earned Leave</option>
                        <option value="emergency">Emergency Leave</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>üìù Reason</label>
                    <textarea id="leaveReason" rows="3" required placeholder="Reason for leave..."></textarea>
                </div>
                <button type="submit" class="btn">Apply for Leave</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://sizbhnyyyvbkuarulcmz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpemJobnl5eXZia3VhcnVsY216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MjcxMzQsImV4cCI6MjA3MDQwMzEzNH0.T67uwBYJp6AbaDB1CwbXh18GjvW9KwPBuyoOhniMaF0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let attendanceData = {
            isCheckedIn: false,
            isOnBreak: false,
            checkInTime: null,
            breakStart: null,
            totalBreakTime: 0
        };
        let realtimeSubscriptions = [];
        let realtimeChannelCount = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Employee Management Portal - Real-time Mode Starting...');
            
            // Initialize real-time status
            updateRealtimeStatus();
            
            // Check authentication
            checkAuth();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start timers
            setInterval(updateWorkingTime, 1000);
            setInterval(updateRealtimeStatus, 5000);
            
            // Force reload every 30 seconds if no real-time
            setInterval(() => {
                if (currentUser && realtimeChannelCount < 3) {
                    console.log('üîÑ Poor real-time connection, attempting reconnect...');
                    setupRealtimeSubscriptions();
                }
            }, 30000);
            
            console.log('‚úÖ Portal initialization complete!');
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
            document.getElementById('addTaskForm').addEventListener('submit', handleAddTask);
            document.getElementById('createRosterForm').addEventListener('submit', handleCreateRoster);
            document.getElementById('applyLeaveForm').addEventListener('submit', handleApplyLeave);

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().substring(0, 7);
            
            document.getElementById('empJoinDate').value = today;
            document.getElementById('taskDueDate').value = today;
            document.getElementById('rosterDate').value = today;
            document.getElementById('leaveFromDate').value = today;
            document.getElementById('leaveToDate').value = today;
            document.getElementById('reportMonth').value = currentMonth;
        }

        function checkAuth() {
            console.log('üîê Checking authentication...');
            
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                try {
                    currentUser = JSON.parse(saved);
                    console.log('‚úÖ User found in localStorage:', currentUser.name);
                    
                    showDashboard();
                    setupNavigation();
                    loadUserData();
                    
                    setTimeout(() => {
                        loadDashboardData();
                        setupRealtimeSubscriptions();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    localStorage.removeItem('currentUser');
                    showLogin();
                }
            } else {
                console.log('üëã No user found, showing login');
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('show');
            cleanupSubscriptions();
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').classList.add('show');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // =================================
        // COMPREHENSIVE REAL-TIME SYSTEM
        // =================================

        function setupRealtimeSubscriptions() {
            cleanupSubscriptions();
            console.log('üî• Setting up COMPLETE real-time system...');
            
            // Reset counter
            realtimeChannelCount = 0;
            
            const channels = [
                { name: 'employees', table: 'employees', handler: handleEmployeeChange },
                { name: 'tasks', table: 'tasks', handler: handleTaskChange },
                { name: 'attendance', table: 'attendance', handler: handleAttendanceChange },
                { name: 'roster', table: 'roster', handler: handleRosterChange },
                { name: 'leave_requests', table: 'leave_requests', handler: handleLeaveChange }
            ];

            channels.forEach((channel, index) => {
                try {
                    const subscription = supabase
                        .channel(`realtime-${channel.name}-${Date.now()}-${index}`)
                        .on('postgres_changes', {
                            event: '*',
                            schema: 'public',
                            table: channel.table
                        }, (payload) => {
                            console.log(`üîÑ REAL-TIME ${channel.name.toUpperCase()}:`, payload);
                            channel.handler(payload);
                            showRealtimeNotification(channel.name, payload);
                        })
                        .subscribe((status) => {
                            console.log(`üì° ${channel.name} channel status:`, status);
                            if (status === 'SUBSCRIBED') {
                                realtimeChannelCount++;
                                console.log(`‚úÖ Channel ${channel.name} connected! (${realtimeChannelCount}/5)`);
                                updateRealtimeStatus();
                            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                                console.error(`‚ùå Channel ${channel.name} failed:`, status);
                            }
                        });
                    
                    realtimeSubscriptions.push(subscription);
                } catch (error) {
                    console.error(`Failed to setup ${channel.name} channel:`, error);
                }
            });

            console.log('‚úÖ All real-time channels initialized');
            
            // Force update status after 3 seconds
            setTimeout(() => {
                updateRealtimeStatus();
                console.log(`üîó Final real-time status: ${realtimeChannelCount}/5 channels active`);
            }, 3000);
        }

        function showRealtimeNotification(type, payload) {
            const icons = {
                employees: 'üë•',
                tasks: 'üìã', 
                attendance: '‚è∞',
                roster: 'üìÖ',
                leave_requests: 'üèñÔ∏è'
            };

            const actions = {
                INSERT: 'Added',
                UPDATE: 'Updated', 
                DELETE: 'Removed'
            };

            const icon = icons[type] || 'üîÑ';
            const action = actions[payload.eventType] || 'Changed';
            
            showNotification(`${icon} ${type.charAt(0).toUpperCase() + type.slice(1)} ${action}!`, 'info');
        }

        function updateRealtimeStatus() {
            const statusEl = document.getElementById('realtimeStatus');
            const connectionEl = document.getElementById('connectionStatus');
            
            console.log(`üìä Updating real-time status: ${realtimeChannelCount}/5 channels`);
            
            if (!statusEl || !connectionEl) {
                console.warn('Status elements not found');
                return;
            }
            
            if (realtimeChannelCount >= 5) {
                statusEl.className = 'realtime-status active';
                statusEl.innerHTML = `<div class="live-dot"></div><span>Real-time Active (${realtimeChannelCount}/5)</span>`;
                connectionEl.textContent = `Live Database (${realtimeChannelCount}/5 channels)`;
                connectionEl.style.color = '#48bb78';
                console.log('‚úÖ All real-time channels active!');
            } else if (realtimeChannelCount > 0) {
                statusEl.className = 'realtime-status';
                statusEl.innerHTML = `<div class="live-dot"></div><span>Connecting... (${realtimeChannelCount}/5)</span>`;
                connectionEl.textContent = `Connecting... (${realtimeChannelCount}/5)`;
                connectionEl.style.color = '#ed8936';
                console.log(`‚è≥ Partial connection: ${realtimeChannelCount}/5`);
            } else {
                statusEl.className = 'realtime-status';
                statusEl.innerHTML = `<span>‚ùå Offline Mode</span>`;
                connectionEl.textContent = 'Offline Mode';
                connectionEl.style.color = '#e53e3e';
                console.log('‚ùå No real-time connection');
            }
        }

        function cleanupSubscriptions() {
            realtimeSubscriptions.forEach(sub => sub.unsubscribe());
            realtimeSubscriptions = [];
            realtimeChannelCount = 0;
            updateRealtimeStatus();
        }

        // =================================
        // REAL-TIME EVENT HANDLERS
        // =================================

        function handleEmployeeChange(payload) {
            console.log('üë• Employee real-time change:', payload);
            
            // Reload employee lists
            loadEmployeeManagement();
            loadAdminStats();
            
            // Update dropdowns
            updateEmployeeDropdowns();
            
            // Show notification
            if (payload.eventType === 'INSERT') {
                showNotification(`New employee: ${payload.new.name} üéâ`, 'success');
            } else if (payload.eventType === 'DELETE') {
                showNotification('Employee removed üëã', 'info');
            }
        }

        function handleTaskChange(payload) {
            console.log('üìã Task real-time change:', payload);
            
            // Reload task data
            loadMyTasks();
            loadTaskManagement();
            
            // Update stats
            if (payload.eventType === 'INSERT') {
                showNotification(`New task assigned! üìù`, 'info');
            }
        }

        function handleAttendanceChange(payload) {
            console.log('‚è∞ Attendance real-time change:', payload);
            
            // Reload attendance data
            loadAdminStats();
            loadLiveAttendance();
            
            // If it's current user's attendance
            if (payload.new && payload.new.employee_id === currentUser.id) {
                loadAttendance();
            }
        }

        function handleRosterChange(payload) {
            console.log('üìÖ Roster real-time change:', payload);
            
            // Reload schedule data
            loadMySchedule();
            
            if (payload.eventType === 'INSERT') {
                showNotification('New roster assignment! üìÖ', 'info');
            }
        }

        function handleLeaveChange(payload) {
            console.log('üèñÔ∏è Leave real-time change:', payload);
            
            // Reload leave data
            loadLeaveManagement();
            
            if (payload.eventType === 'INSERT') {
                showNotification('New leave request! üèñÔ∏è', 'info');
            } else if (payload.eventType === 'UPDATE' && payload.new.status !== payload.old.status) {
                const status = payload.new.status;
                if (status === 'approved') {
                    showNotification('Leave approved! ‚úÖ', 'success');
                } else if (status === 'rejected') {
                    showNotification('Leave rejected! ‚ùå', 'error');
                }
            }
        }

        // =================================
        // AUTHENTICATION FUNCTIONS
        // =================================

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading('loginBtnText', 'loginLoader');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                const { data: profile } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profile) {
                    currentUser = {
                        id: profile.id,
                        name: profile.name,
                        email: profile.email,
                        role: profile.role,
                        department: profile.department,
                        phone: profile.phone,
                        salary: profile.salary,
                        join_date: profile.join_date,
                        isDemo: false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showNotification('Login successful! üéâ', 'success');
                    showDashboard();
                    setupNavigation();
                    loadUserData();
                    loadDashboardData();
                    setupRealtimeSubscriptions();
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed. Try demo login. ‚ùå', 'error');
            } finally {
                hideLoading('loginBtnText', 'loginLoader');
            }
        }

        function demoLogin(type) {
            console.log(`üéØ Demo login initiated: ${type}`);
            
            const demoUsers = {
                admin: { 
                    id: 'demo_admin_user', 
                    name: 'Admin User', 
                    email: 'admin@demo.com', 
                    role: 'admin', 
                    department: 'Management', 
                    phone: '+91 9876543210',
                    salary: 100000,
                    join_date: '2023-01-01',
                    isDemo: false
                },
                employee: { 
                    id: 'demo_employee_user', 
                    name: 'John Doe', 
                    email: 'john@demo.com', 
                    role: 'employee', 
                    department: 'IT', 
                    phone: '+91 9876543211',
                    salary: 50000,
                    join_date: '2023-06-01',
                    isDemo: false
                }
            };
            
            currentUser = demoUsers[type];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            console.log('‚úÖ Demo user set:', currentUser);
            
            showNotification(`Welcome ${currentUser.name}! Real-time mode active üöÄ`, 'success');
            showDashboard();
            setupNavigation();
            loadUserData();
            
            // Load data with delay to ensure DOM is ready
            setTimeout(() => {
                loadDashboardData();
                setupRealtimeSubscriptions();
            }, 500);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            if (currentUser) {
                const today = new Date().toISOString().split('T')[0];
                localStorage.removeItem(`attendance_${currentUser.id}_${today}`);
            }
            
            currentUser = null;
            attendanceData = {
                isCheckedIn: false,
                isOnBreak: false,
                checkInTime: null,
                breakStart: null,
                totalBreakTime: 0
            };
            cleanupSubscriptions();
            showNotification('Logged out successfully! üëã', 'info');
            showLogin();
        }

        // =================================
        // DATABASE OPERATIONS
        // =================================

        async function handleAddEmployee(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('empName').value,
                email: document.getElementById('empEmail').value,
                phone: document.getElementById('empPhone').value || null,
                department: document.getElementById('empDepartment').value,
                role: document.getElementById('empRole').value,
                salary: parseFloat(document.getElementById('empSalary').value) || null,
                join_date: document.getElementById('empJoinDate').value || null
            };
            
            // Validate required fields
            if (!employeeData.name || !employeeData.email) {
                showNotification('Name and Email are required! ‚ö†Ô∏è', 'error');
                return;
            }
            
            console.log('Adding employee:', employeeData);
            
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .insert([employeeData])
                    .select();

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Employee added successfully:', data);
                showNotification('Employee added successfully! üéâ', 'success');
                closeModal('addEmployeeModal');
                e.target.reset();
                
            } catch (error) {
                console.error('Add employee error:', error);
                showNotification(`Failed to add employee: ${error.message} ‚ùå`, 'error');
            }
        }

        async function handleAddTask(e) {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value,
                assigned_to: document.getElementById('taskAssignTo').value,
                status: 'pending',
                created_by: currentUser.id
            };
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .insert([taskData]);

                if (error) throw error;
                
                showNotification('Task assigned successfully! üéâ', 'success');
                closeModal('addTaskModal');
                e.target.reset();
                
            } catch (error) {
                console.error('Add task error:', error);
                showNotification('Failed to assign task ‚ùå', 'error');
            }
        }

        async function handleCreateRoster(e) {
            e.preventDefault();
            
            const rosterData = {
                employee_id: document.getElementById('rosterEmployee').value,
                date: document.getElementById('rosterDate').value,
                shift: document.getElementById('rosterShift').value,
                location: document.getElementById('rosterLocation').value,
                notes: document.getElementById('rosterNotes').value,
                created_by: currentUser.id
            };
            
            try {
                const { error } = await supabase
                    .from('roster')
                    .upsert([rosterData]);

                if (error) throw error;
                
                showNotification('Roster created successfully! üìÖ', 'success');
                closeModal('createRosterModal');
                e.target.reset();
                
            } catch (error) {
                console.error('Create roster error:', error);
                showNotification('Failed to create roster ‚ùå', 'error');
            }
        }

        async function handleApplyLeave(e) {
            e.preventDefault();
            
            const leaveData = {
                employee_id: currentUser.id,
                leave_type: document.getElementById('leaveType').value,
                from_date: document.getElementById('leaveFromDate').value,
                to_date: document.getElementById('leaveToDate').value,
                reason: document.getElementById('leaveReason').value,
                status: 'pending'
            };
            
            try {
                const { error } = await supabase
                    .from('leave_requests')
                    .insert([leaveData]);

                if (error) throw error;
                
                showNotification('Leave application submitted! üèñÔ∏è', 'success');
                closeModal('applyLeaveModal');
                e.target.reset();
                
            } catch (error) {
                console.error('Apply leave error:', error);
                showNotification('Failed to submit leave application ‚ùå', 'error');
            }
        }

        // =================================
        // DATA LOADING FUNCTIONS
        // =================================

        function setupNavigation() {
            console.log('üß≠ Setting up navigation for:', currentUser.role);
            
            const navTabs = document.getElementById('navTabs');
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            const tabs = [
                { id: 'employeeDashboard', label: 'üè† Dashboard', show: true },
                { id: 'employeeManagement', label: 'üë• Employees', show: isAdmin },
                { id: 'attendanceReports', label: 'üìä Reports', show: isAdmin },
                { id: 'taskManagement', label: 'üìã Tasks', show: isAdmin },
                { id: 'leaveManagement', label: 'üèñÔ∏è Leave', show: true }
            ];

            const visibleTabs = tabs.filter(tab => tab.show);
            
            navTabs.innerHTML = visibleTabs
                .map((tab, index) => 
                    `<button class="nav-tab ${index === 0 ? 'active' : ''}" onclick="switchTab('${tab.id}')">${tab.label}</button>`
                ).join('');

            console.log('‚úÖ Navigation tabs created:', visibleTabs.length);
            
            // Show first tab immediately
            setTimeout(() => {
                switchTab('employeeDashboard');
            }, 100);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            // Find and activate the clicked tab
            const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(tab => 
                tab.onclick && tab.onclick.toString().includes(tabId)
            );
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            loadTabData(tabId);
        }

        function loadTabData(tabId) {
            switch(tabId) {
                case 'employeeDashboard':
                    loadEmployeeDashboard();
                    break;
                case 'employeeManagement':
                    loadEmployeeManagement();
                    break;
                case 'attendanceReports':
                    loadAttendanceReport();
                    break;
                case 'taskManagement':
                    loadTaskManagement();
                    break;
                case 'leaveManagement':
                    loadLeaveManagement();
                    break;
            }
        }

        function loadUserData() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
        }

        function loadDashboardData() {
            console.log('üîÑ Loading dashboard data...');
            
            try {
                // Load attendance first
                loadAttendance();
                
                // Load other data with small delays
                setTimeout(() => {
                    loadMyTasks();
                }, 200);
                
                setTimeout(() => {
                    loadMySchedule();
                }, 400);
                
                setTimeout(() => {
                    loadEmployeeDashboard();
                }, 600);
                
                // Admin specific data
                if (currentUser && currentUser.role === 'admin') {
                    setTimeout(() => {
                        loadAdminStats();
                    }, 800);
                    
                    setTimeout(() => {
                        loadLiveAttendance();
                    }, 1000);
                }
                
                console.log('‚úÖ Dashboard data loading initiated');
                
            } catch (error) {
                console.error('Error in loadDashboardData:', error);
            }
        }

        async function loadEmployeeManagement() {
            const container = document.getElementById('employeeList');
            
            try {
                const { data: employees, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (employees && employees.length > 0) {
                    container.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 10px; background: #e6f7ff; border-radius: 8px; text-align: center;">
                            <strong>‚ö° Real-time Database: ${employees.length} employees</strong>
                        </div>
                    ` + employees.map(emp => `
                        <div class="employee-card">
                            <div class="employee-info">
                                <h4>${emp.name}</h4>
                                <p>üìß ${emp.email} | üè¢ ${emp.department} | üë§ ${emp.role}</p>
                                <p>üìû ${emp.phone || 'N/A'} | üí∞ ‚Çπ${emp.salary || 'N/A'} | üìÖ ${emp.join_date || 'N/A'}</p>
                            </div>
                            <div class="employee-actions">
                                <button class="btn-small btn-danger" onclick="deleteEmployee('${emp.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');

                    updateEmployeeDropdowns();
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No employees found</p>';
                }
                
            } catch (error) {
                console.error('Error loading employees:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading employees</p>';
            }
        }

        async function updateEmployeeDropdowns() {
            try {
                const { data: employees } = await supabase
                    .from('employees')
                    .select('id, name')
                    .order('name');

                const options = employees?.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('') || '';
                
                const selects = ['taskAssignTo', 'rosterEmployee'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">Select Employee</option>' + options;
                    }
                });
            } catch (error) {
                console.error('Error updating dropdowns:', error);
            }
        }

        async function deleteEmployee(employeeId) {
            if (!confirm('Are you sure you want to delete this employee?')) return;
            
            try {
                const { error } = await supabase
                    .from('employees')
                    .delete()
                    .eq('id', employeeId);

                if (error) throw error;
                
                showNotification('Employee deleted successfully! üóëÔ∏è', 'success');
                
            } catch (error) {
                console.error('Delete employee error:', error);
                showNotification('Failed to delete employee ‚ùå', 'error');
            }
        }

        async function loadMyTasks() {
            const container = document.getElementById('myTaskList');
            
            if (!container) {
                console.warn('myTaskList container not found');
                return;
            }
            
            try {
                console.log('üìã Loading tasks for user:', currentUser.id);
                
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('assigned_to', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Tasks loading error:', error);
                    container.innerHTML = '<p style="color: #e53e3e;">Error loading tasks</p>';
                    return;
                }
                
                console.log('üìã Tasks loaded:', tasks?.length || 0);
                
                if (tasks && tasks.length > 0) {
                    container.innerHTML = tasks.map(task => `
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <span class="priority-${task.priority}">${getPriorityIcon(task.priority)} ${task.priority.toUpperCase()}</span>
                            </div>
                            <p>${task.description || 'No description'}</p>
                            <div class="task-meta">
                                <span>Due: ${new Date(task.due_date).toLocaleDateString()}</span>
                                <span>Status: ${task.status}</span>
                                <button class="btn-small btn-info" onclick="updateTaskStatus('${task.id}', '${task.status}')">
                                    ${task.status === 'pending' ? '‚ñ∂Ô∏è Start' : task.status === 'in_progress' ? '‚úÖ Complete' : '‚úÖ Done'}
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update stats
                    const totalTasksEl = document.getElementById('totalTasks');
                    if (totalTasksEl) {
                        totalTasksEl.textContent = tasks.length;
                    }
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No tasks assigned yet</p>';
                    const totalTasksEl = document.getElementById('totalTasks');
                    if (totalTasksEl) {
                        totalTasksEl.textContent = '0';
                    }
                }
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading tasks</p>';
            }
        }

        async function loadTaskManagement() {
            const container = document.getElementById('allTasksList');
            
            try {
                const { data: tasks } = await supabase
                    .from('tasks')
                    .select(`
                        *,
                        employees!inner(name)
                    `)
                    .order('created_at', { ascending: false });

                if (tasks && tasks.length > 0) {
                    container.innerHTML = tasks.map(task => `
                        <div class="task-item">
                            <div class="task-header">
                                <div>
                                    <div class="task-title">${task.title}</div>
                                    <p>Assigned to: ${task.employees.name}</p>
                                </div>
                                <span class="priority-${task.priority}">${getPriorityIcon(task.priority)} ${task.priority.toUpperCase()}</span>
                            </div>
                            <p>${task.description || 'No description'}</p>
                            <div class="task-meta">
                                <span>Due: ${new Date(task.due_date).toLocaleDateString()}</span>
                                <span>Status: ${task.status}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No tasks assigned yet</p>';
                }
                
            } catch (error) {
                console.error('Error loading all tasks:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading tasks</p>';
            }
        }

        async function updateTaskStatus(taskId, currentStatus) {
            const nextStatus = currentStatus === 'pending' ? 'in_progress' : 
                             currentStatus === 'in_progress' ? 'completed' : 'completed';
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .update({ status: nextStatus })
                    .eq('id', taskId);

                if (error) throw error;
                
                showNotification('Task status updated! ‚úÖ', 'success');
                
            } catch (error) {
                console.error('Update task error:', error);
                showNotification('Failed to update task ‚ùå', 'error');
            }
        }

        async function loadMySchedule() {
            const container = document.getElementById('mySchedule');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data: todayRoster } = await supabase
                    .from('roster')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .eq('date', today)
                    .single();

                if (todayRoster) {
                    container.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <h4>üìÖ Today's Schedule</h4>
                            <div style="padding: 10px; background: #e6f7ff; border-radius: 8px; margin-top: 10px;">
                                <p><strong>${getShiftTime(todayRoster.shift)}</strong></p>
                                <p>${getShiftIcon(todayRoster.shift)} ${todayRoster.shift.charAt(0).toUpperCase() + todayRoster.shift.slice(1)} Shift | ${getLocationIcon(todayRoster.location)} ${todayRoster.location.charAt(0).toUpperCase() + todayRoster.location.slice(1)}</p>
                                <p>üìù ${todayRoster.notes || 'Regular working day'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <h4>üìÖ Today's Schedule</h4>
                            <div style="padding: 10px; background: #f7fafc; border-radius: 8px; margin-top: 10px;">
                                <p style="color: #666;">No schedule assigned for today</p>
                                <p style="font-size: 12px;">Default: 9 AM - 6 PM</p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading schedule</p>';
            }
        }

        async function loadLeaveManagement() {
            const container = document.getElementById('leaveRequestsList');
            
            try {
                const { data: leaveRequests } = await supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .order('created_at', { ascending: false });

                container.innerHTML = `
                    <div class="card">
                        <h3>üìä Leave Balance</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #48bb78;">12</div>
                                <div style="font-size: 12px; color: #666;">Casual Leave</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #4299e1;">7</div>
                                <div style="font-size: 12px; color: #666;">Sick Leave</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #ed8936;">21</div>
                                <div style="font-size: 12px; color: #666;">Earned Leave</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üìù Leave Requests</h3>
                        ${!leaveRequests || leaveRequests.length === 0 ? 
                            '<p style="text-align: center; color: #666;">No leave requests yet</p>' : 
                            leaveRequests.map(request => `
                                <div class="task-item">
                                    <div class="task-header">
                                        <div>
                                            <div class="task-title">${request.leave_type.charAt(0).toUpperCase() + request.leave_type.slice(1)} Leave</div>
                                            <p>${new Date(request.from_date).toLocaleDateString()} - ${new Date(request.to_date).toLocaleDateString()}</p>
                                        </div>
                                        <span class="status-badge ${getLeaveStatusClass(request.status)}">${getLeaveStatusIcon(request.status)} ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span>
                                    </div>
                                    <p>${request.reason}</p>
                                    <div class="task-meta">
                                        <span>Applied: ${new Date(request.created_at).toLocaleDateString()}</span>
                                        <span>${calculateLeaveDays(request.from_date, request.to_date)} days</span>
                                        ${currentUser.role === 'admin' && request.status === 'pending' ? `
                                            <button class="btn-small btn-success" onclick="approveLeave('${request.id}')">‚úÖ Approve</button>
                                            <button class="btn-small btn-danger" onclick="rejectLeave('${request.id}')">‚ùå Reject</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading leave management:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading leave data</p>';
            }
        }

        async function loadAdminStats() {
            if (currentUser.role !== 'admin') return;
            
            try {
                const { data: employees } = await supabase
                    .from('employees')
                    .select('id');
                
                const today = new Date().toISOString().split('T')[0];
                const { data: attendance } = await supabase
                    .from('attendance')
                    .select('status')
                    .eq('date', today);
                
                const totalEmployees = employees?.length || 0;
                const presentToday = attendance?.filter(a => a.status === 'present').length || 0;
                const absentToday = totalEmployees - presentToday;
                
                document.getElementById('totalEmployees').textContent = totalEmployees;
                document.getElementById('presentToday').textContent = presentToday;
                document.getElementById('absentToday').textContent = absentToday;
                document.getElementById('onBreak').textContent = '0';
                
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadLiveAttendance() {
            const container = document.getElementById('liveAttendance');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data: liveData } = await supabase
                    .from('employees')
                    .select(`
                        name, 
                        department,
                        attendance!left(status, check_in)
                    `)
                    .eq('attendance.date', today);

                if (liveData && liveData.length > 0) {
                    container.innerHTML = `
                        <div style="margin-bottom: 10px; font-size: 12px; color: #666; text-align: center;">
                            ‚ö° Real-time attendance data
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${liveData.map(emp => `
                                <div class="employee-card" style="margin-bottom: 10px; padding: 15px;">
                                    <div>
                                        <h4>${emp.name}</h4>
                                        <p>${emp.department} Department</p>
                                    </div>
                                    <span class="status-badge ${emp.attendance && emp.attendance.length > 0 && emp.attendance[0].status === 'present' ? 'status-working' : 'status-out'}">
                                        ${emp.attendance && emp.attendance.length > 0 && emp.attendance[0].status === 'present' ? 'üíº Working' : 'üè† Not Checked In'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No attendance data found</p>';
                }
                
            } catch (error) {
                console.error('Error loading live attendance:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading attendance data</p>';
            }
        }

        async function loadEmployeeDashboard() {
            try {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const { data: weekAttendance } = await supabase
                    .from('attendance')
                    .select('total_hours')
                    .eq('employee_id', currentUser.id)
                    .gte('date', weekStart.toISOString().split('T')[0])
                    .lte('date', weekEnd.toISOString().split('T')[0]);
                
                const totalWeekHours = weekAttendance?.reduce((sum, record) => sum + (record.total_hours || 0), 0) || 0;
                document.getElementById('thisWeekHours').textContent = `${Math.floor(totalWeekHours)}h ${Math.floor((totalWeekHours % 1) * 60)}m`;
                
            } catch (error) {
                console.error('Error loading employee dashboard:', error);
            }
        }

        async function loadAttendanceReport() {
            const container = document.getElementById('attendanceReportData');
            const month = document.getElementById('reportMonth').value;
            
            if (!month) {
                container.innerHTML = '<p style="color: #666;">Please select a month</p>';
                return;
            }
            
            try {
                const startDate = month + '-01';
                const endDate = new Date(month + '-01');
                endDate.setMonth(endDate.getMonth() + 1);
                endDate.setDate(0);
                const endDateStr = endDate.toISOString().split('T')[0];

                const { data: reportData } = await supabase
                    .from('employees')
                    .select(`
                        name,
                        department,
                        attendance!left(date, status, total_hours)
                    `)
                    .gte('attendance.date', startDate)
                    .lte('attendance.date', endDateStr);

                if (reportData && reportData.length > 0) {
                    const processedData = reportData.map(emp => {
                        const attendance = emp.attendance || [];
                        const presentDays = attendance.filter(a => a.status === 'present').length;
                        const totalHours = attendance.reduce((sum, a) => sum + (a.total_hours || 0), 0);
                        const workingDays = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
                        const absentDays = workingDays - presentDays;
                        
                        return {
                            name: emp.name,
                            department: emp.department,
                            presentDays,
                            absentDays,
                            totalHours: Math.round(totalHours),
                            status: presentDays >= workingDays * 0.9 ? 'Excellent' : 
                                   presentDays >= workingDays * 0.8 ? 'Good' : 'Average'
                        };
                    });

                    container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Present Days</th>
                                    <th>Absent Days</th>
                                    <th>Total Hours</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${processedData.map(emp => `
                                    <tr>
                                        <td>${emp.name}</td>
                                        <td>${emp.department}</td>
                                        <td>${emp.presentDays}</td>
                                        <td>${emp.absentDays}</td>
                                        <td>${emp.totalHours}h</td>
                                        <td><span class="status-badge ${emp.status === 'Excellent' ? 'status-working' : emp.status === 'Good' ? 'status-working' : 'status-break'}">${emp.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No attendance data for selected month</p>';
                }
                
            } catch (error) {
                console.error('Error loading attendance report:', error);
                container.innerHTML = '<p style="color: #e53e3e;">Error loading report data</p>';
            }
        }

        // =================================
        // ATTENDANCE MANAGEMENT
        // =================================

        function loadAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`attendance_${currentUser.id}_${today}`);
            if (saved) {
                attendanceData = JSON.parse(saved);
                if (attendanceData.checkInTime) {
                    attendanceData.checkInTime = new Date(attendanceData.checkInTime);
                }
                if (attendanceData.breakStart) {
                    attendanceData.breakStart = new Date(attendanceData.breakStart);
                }
            }
            updateAttendanceUI();
        }

        function saveAttendance() {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`attendance_${currentUser.id}_${today}`, JSON.stringify(attendanceData));
        }

        async function checkIn() {
            try {
                const checkInTime = new Date();
                attendanceData.isCheckedIn = true;
                attendanceData.checkInTime = checkInTime;
                
                const { error } = await supabase
                    .from('attendance')
                    .upsert({
                        employee_id: currentUser.id,
                        date: new Date().toISOString().split('T')[0],
                        check_in: checkInTime.toTimeString().split(' ')[0],
                        status: 'present'
                    });

                if (error) throw error;
                
                saveAttendance();
                updateAttendanceUI();
                showNotification('Checked in successfully! ‚úÖ', 'success');
                
            } catch (error) {
                console.error('Check-in error:', error);
                showNotification('Check-in failed ‚ùå', 'error');
            }
        }

        async function checkOut() {
            try {
                const checkOutTime = new Date();
                const totalMs = checkOutTime - attendanceData.checkInTime - attendanceData.totalBreakTime;
                const totalHours = Math.round((totalMs / (1000 * 60 * 60)) * 100) / 100;
                
                const { error } = await supabase
                    .from('attendance')
                    .update({
                        check_out: checkOutTime.toTimeString().split(' ')[0],
                        total_hours: totalHours,
                        break_time: Math.round(attendanceData.totalBreakTime / (1000 * 60))
                    })
                    .eq('employee_id', currentUser.id)
                    .eq('date', new Date().toISOString().split('T')[0]);

                if (error) throw error;
                
                attendanceData = {
                    isCheckedIn: false,
                    isOnBreak: false,
                    checkInTime: null,
                    breakStart: null,
                    totalBreakTime: 0
                };
                
                saveAttendance();
                updateAttendanceUI();
                showNotification('Checked out successfully! üèÅ', 'success');
                
            } catch (error) {
                console.error('Check-out error:', error);
                showNotification('Check-out failed ‚ùå', 'error');
            }
        }

        function toggleBreak() {
            if (!attendanceData.isCheckedIn) return;
            
            if (attendanceData.isOnBreak) {
                const breakDuration = new Date() - attendanceData.breakStart;
                attendanceData.totalBreakTime += breakDuration;
                attendanceData.isOnBreak = false;
                attendanceData.breakStart = null;
                showNotification('Break ended ‚è∞', 'info');
            } else {
                attendanceData.isOnBreak = true;
                attendanceData.breakStart = new Date();
                showNotification('Break started ‚òï', 'info');
            }
            
            saveAttendance();
            updateAttendanceUI();
        }

        function updateAttendanceUI() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const breakBtn = document.getElementById('breakBtn');
            const status = document.getElementById('attendanceStatus');
            const checkInTimeEl = document.getElementById('checkInTime');
            
            checkInBtn.disabled = attendanceData.isCheckedIn;
            checkOutBtn.disabled = !attendanceData.isCheckedIn;
            breakBtn.disabled = !attendanceData.isCheckedIn;
            
            if (attendanceData.isCheckedIn) {
                checkInBtn.textContent = '‚úÖ Checked In';
                breakBtn.textContent = attendanceData.isOnBreak ? 'End Break' : 'Start Break';
                
                if (attendanceData.isOnBreak) {
                    status.className = 'status-badge status-break';
                    status.textContent = '‚òï On Break';
                } else {
                    status.className = 'status-badge status-working';
                    status.textContent = 'üíº Working';
                }
            } else {
                checkInBtn.textContent = 'Check In';
                breakBtn.textContent = 'Break';
                status.className = 'status-badge status-out';
                status.textContent = 'üè† Not Checked In';
            }
            
            if (attendanceData.checkInTime) {
                checkInTimeEl.textContent = attendanceData.checkInTime.toTimeString().substr(0, 5);
            } else {
                checkInTimeEl.textContent = '--:--';
            }
        }

        function updateWorkingTime() {
            if (attendanceData.isCheckedIn && attendanceData.checkInTime) {
                const now = new Date();
                let workingMs = now - attendanceData.checkInTime - attendanceData.totalBreakTime;
                
                if (attendanceData.isOnBreak && attendanceData.breakStart) {
                    const currentBreakMs = now - attendanceData.breakStart;
                    workingMs -= currentBreakMs;
                }
                
                const hours = Math.floor(workingMs / (1000 * 60 * 60));
                const minutes = Math.floor((workingMs % (1000 * 60 * 60)) / (1000 * 60));
                
                const timeStr = `${hours}h ${minutes}m`;
                document.getElementById('workingTime').textContent = timeStr;
                document.getElementById('todayHours').textContent = timeStr;
                
                let totalBreakMs = attendanceData.totalBreakTime;
                if (attendanceData.isOnBreak && attendanceData.breakStart) {
                    totalBreakMs += (now - attendanceData.breakStart);
                }
                const breakHours = Math.floor(totalBreakMs / (1000 * 60 * 60));
                const breakMinutes = Math.floor((totalBreakMs % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('breakTime').textContent = `${breakHours}h ${breakMinutes}m`;
            }
        }

        // =================================
        // UTILITY FUNCTIONS
        // =================================

        function getPriorityIcon(priority) {
            switch(priority) {
                case 'high': return 'üî¥';
                case 'medium': return 'üü°';
                case 'low': return 'üü¢';
                default: return '‚ö™';
            }
        }

        function getShiftTime(shift) {
            switch(shift) {
                case 'morning': return 'üïò 9:00 AM - 6:00 PM';
                case 'evening': return 'üïê 2:00 PM - 11:00 PM';
                case 'night': return 'üïö 11:00 PM - 8:00 AM';
                case 'half': return 'üïò 9:00 AM - 1:00 PM';
                default: return 'üïò 9:00 AM - 6:00 PM';
            }
        }

        function getShiftIcon(shift) {
            switch(shift) {
                case 'morning': return 'üåÖ';
                case 'evening': return 'üåÜ';
                case 'night': return 'üåô';
                case 'half': return 'üïê';
                default: return 'üåÖ';
            }
        }

        function getLocationIcon(location) {
            switch(location) {
                case 'office': return 'üè¢';
                case 'remote': return 'üè†';
                case 'hybrid': return 'üîÑ';
                default: return 'üè¢';
            }
        }

        function getLeaveStatusClass(status) {
            switch(status) {
                case 'approved': return 'status-working';
                case 'rejected': return 'status-out';
                case 'pending': return 'status-break';
                default: return 'status-break';
            }
        }

        function getLeaveStatusIcon(status) {
            switch(status) {
                case 'approved': return '‚úÖ';
                case 'rejected': return '‚ùå';
                case 'pending': return '‚è≥';
                default: return '‚è≥';
            }
        }

        function calculateLeaveDays(fromDate, toDate) {
            const start = new Date(fromDate);
            const end = new Date(toDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        async function approveLeave(leaveId) {
            try {
                const { error } = await supabase
                    .from('leave_requests')
                    .update({ status: 'approved' })
                    .eq('id', leaveId);

                if (error) throw error;
                showNotification('Leave approved! ‚úÖ', 'success');
                
            } catch (error) {
                console.error('Approve leave error:', error);
                showNotification('Failed to approve leave ‚ùå', 'error');
            }
        }

        async function rejectLeave(leaveId) {
            try {
                const { error } = await supabase
                    .from('leave_requests')
                    .update({ status: 'rejected' })
                    .eq('id', leaveId);

                if (error) throw error;
                showNotification('Leave rejected! ‚ùå', 'error');
                
            } catch (error) {
                console.error('Reject leave error:', error);
                showNotification('Failed to reject leave ‚ùå', 'error');
            }
        }

        function showLoading(textElementId, loaderElementId) {
            document.getElementById(textElementId).style.display = 'none';
            document.getElementById(loaderElementId).style.display = 'inline-block';
        }

        function hideLoading(textElementId, loaderElementId) {
            document.getElementById(textElementId).style.display = 'inline';
            document.getElementById(loaderElementId).style.display = 'none';
        }

        function openAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('show');
        }

        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('show');
        }

        function openCreateRosterModal() {
            document.getElementById('createRosterModal').classList.add('show');
        }

        function openApplyLeaveModal() {
            document.getElementById('applyLeaveModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Placeholder functions for future features
        function exportAttendance() {
            showNotification('Export feature coming soon! üìä', 'info');
        }

        function exportAttendanceReport() {
            showNotification('Export feature coming soon! üìä', 'info');
        }

        // =================================
        // DATABASE CONNECTION CHECK
        // =================================

        async function checkDatabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connectionStatus').textContent = `Live Database (${realtimeChannelCount}/5 channels)`;
                document.getElementById('connectionStatus').style.color = '#48bb78';
                console.log('Database connection: ‚úÖ OK');
                return true;
                
            } catch (error) {
                console.error('Database connection failed:', error);
                document.getElementById('connectionStatus').textContent = 'Database Error';
                document.getElementById('connectionStatus').style.color = '#e53e3e';
                return false;
            }
        }

        // =================================
        // EVENT LISTENERS
        // =================================

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('An unexpected error occurred. Please try again. ‚ö†Ô∏è', 'error');
        });

        // Network status monitoring
        window.addEventListener('online', function() {
            showNotification('Connection restored! üåê', 'success');
            if (currentUser) {
                loadDashboardData();
                setupRealtimeSubscriptions();
            }
        });

        window.addEventListener('offline', function() {
            showNotification('No internet connection! üì±', 'error');
            cleanupSubscriptions();
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                }, 0);
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            cleanupSubscriptions();
        });

        // Auto-refresh data every 2 minutes to ensure freshness
        setInterval(() => {
            if (currentUser && realtimeChannelCount >= 5) {
                console.log('üîÑ Auto-refresh: Real-time is active, skipping manual refresh');
            } else if (currentUser) {
                console.log('üîÑ Auto-refresh: Loading fresh data (real-time inactive)');
                loadDashboardData();
            }
        }, 120000); // 2 minutes

        // Real-time connection health check
        setInterval(() => {
            if (currentUser) {
                checkDatabaseConnection();
            }
        }, 30000); // 30 seconds

        // =================================
        // ADVANCED REAL-TIME FEATURES
        // =================================

        // Live cursor/user presence (optional enhancement)
        function setupUserPresence() {
            if (!currentUser) return;
            
            const presenceChannel = supabase.channel('user-presence', {
                config: {
                    presence: {
                        key: currentUser.id,
                    },
                },
            });

            presenceChannel.on('presence', { event: 'sync' }, () => {
                const state = presenceChannel.presenceState();
                const users = Object.keys(state).length;
                console.log('üë• Users online:', users);
                
                // Update UI to show online users count
                const statusEl = document.getElementById('realtimeStatus');
                if (statusEl && users > 1) {
                    statusEl.innerHTML += ` <span style="margin-left: 10px; font-size: 10px;">üë• ${users} online</span>`;
                }
            });

            presenceChannel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await presenceChannel.track({
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        online_at: new Date().toISOString(),
                    });
                }
            });

            realtimeSubscriptions.push(presenceChannel);
        }

        // Batch operations for better performance
        async function batchUpdateTasks(updates) {
            try {
                const { error } = await supabase
                    .from('tasks')
                    .upsert(updates);

                if (error) throw error;
                showNotification(`${updates.length} tasks updated! üìã`, 'success');
                
            } catch (error) {
                console.error('Batch update error:', error);
                showNotification('Batch update failed ‚ùå', 'error');
            }
        }

        // Advanced search functionality
        async function searchEmployees(query) {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .or(`name.ilike.%${query}%,email.ilike.%${query}%,department.ilike.%${query}%`)
                    .limit(10);

                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }

        // Real-time notifications system
        function setupNotificationSystem() {
            // Listen for important events and show system notifications
            const notificationChannel = supabase
                .channel('system-notifications')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'tasks',
                    filter: `assigned_to=eq.${currentUser.id}`
                }, (payload) => {
                    // Show browser notification for new tasks
                    if (Notification.permission === 'granted') {
                        new Notification('New Task Assigned!', {
                            body: `You have been assigned: ${payload.new.title}`,
                            icon: '/favicon.ico'
                        });
                    }
                })
                .subscribe();

            realtimeSubscriptions.push(notificationChannel);
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('Browser notifications enabled! üîî', 'success');
                        setupNotificationSystem();
                    }
                });
            }
        }

        // =================================
        // INITIALIZATION COMPLETE
        // =================================

        // Initialize advanced features when user logs in
        function initializeAdvancedFeatures() {
            setupUserPresence();
            requestNotificationPermission();
            
            // Log successful initialization
            console.log('üéâ Employee Management Portal - Real-time Mode Initialized!');
            console.log('‚úÖ Features: Real-time sync, Live presence, Browser notifications');
            console.log('üöÄ Ready for production use!');
        }

        // Call advanced features setup after successful authentication
        if (currentUser) {
            setTimeout(initializeAdvancedFeatures, 2000);
        }

        // =================================
        // DEBUGGING AND MONITORING
        // =================================

        // Development mode logging
        const isDevelopment = window.location.hostname === 'localhost';
        
        if (isDevelopment) {
            console.log('üîß Development Mode: Enhanced logging enabled');
            
            // Log all real-time events in development
            window.debugRealtime = {
                logEvents: true,
                subscriptions: realtimeSubscriptions,
                currentUser: currentUser,
                attendanceData: attendanceData
            };
        }

        // Performance metrics
        const performanceMetrics = {
            pageLoadTime: 0,
            realtimeSetupTime: 0,
            averageResponseTime: 0
        };

        // Export for debugging
        window.employeePortal = {
            currentUser,
            realtimeSubscriptions,
            performanceMetrics,
            supabase,
            version: '2.0.0-realtime'
        };

        console.log('üöÄ Employee Management Portal v2.0.0 - Real-time Edition Ready!');
    </script>
</body>
</html>
