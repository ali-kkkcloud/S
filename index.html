<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-demo {
            background: #48bb78;
            font-size: 12px;
            padding: 8px;
            margin: 5px;
            width: auto;
            display: inline-block;
        }

        .btn-demo:hover {
            background: #38a169;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.show {
            display: block;
        }

        .header {
            background: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #c53030;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Attendance Card */
        .attendance-card .status {
            text-align: center;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-working { background: #c6f6d5; color: #22543d; }
        .status-break { background: #fef5e7; color: #975a16; }
        .status-out { background: #fed7d7; color: #742a2a; }

        .time-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: center;
        }

        .time-item h4 {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .time-item span {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 80px;
            font-size: 12px;
            padding: 8px;
        }

        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }

        /* Tasks Card */
        .task-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .task-item {
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .task-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .task-item p {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .priority-high { color: #e53e3e; font-weight: bold; }
        .priority-medium { color: #ed8936; font-weight: bold; }
        .priority-low { color: #48bb78; font-weight: bold; }

        .add-task-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
        }

        .add-task-btn:hover {
            background: #5a67d8;
        }

        /* Profile Card */
        .profile-info {
            display: grid;
            gap: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-label {
            font-weight: bold;
            color: #4a5568;
        }

        .info-value {
            color: #2d3748;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1001;
            display: none;
        }

        .notification.success { background: #48bb78; }
        .notification.error { background: #e53e3e; }
        .notification.info { background: #4299e1; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 10px; text-align: center; }
            .action-buttons { flex-direction: column; }
            .time-display { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <h1>Employee Portal</h1>
            <form id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            
            <div style="margin-top: 20px;">
                <p style="margin-bottom: 10px; color: #666;">Quick Demo:</p>
                <button class="btn btn-demo" onclick="demoLogin('admin')">Admin</button>
                <button class="btn btn-demo" onclick="demoLogin('employee')">Employee</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>Welcome, <span id="userName">Employee</span></h1>
                <div class="user-info">
                    <span id="userEmail">user@example.com</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="grid">
                <!-- Attendance Card -->
                <div class="card attendance-card">
                    <h2>Attendance</h2>
                    
                    <div class="status">
                        <span id="attendanceStatus" class="status-badge status-out">Not Checked In</span>
                    </div>
                    
                    <div class="time-display">
                        <div class="time-item">
                            <h4>Check In</h4>
                            <span id="checkInTime">--:--</span>
                        </div>
                        <div class="time-item">
                            <h4>Working</h4>
                            <span id="workingTime">0h 0m</span>
                        </div>
                        <div class="time-item">
                            <h4>Check Out</h4>
                            <span id="checkOutTime">--:--</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="checkInBtn" class="btn btn-success" onclick="checkIn()">Check In</button>
                        <button id="checkOutBtn" class="btn btn-danger" onclick="checkOut()" disabled>Check Out</button>
                        <button id="breakBtn" class="btn btn-warning" onclick="toggleBreak()" disabled>Break</button>
                    </div>
                </div>

                <!-- Tasks Card -->
                <div class="card">
                    <h2>My Tasks</h2>
                    <button class="add-task-btn" onclick="openModal()">+ Add Task</button>
                    <div id="taskList" class="task-list">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- Profile Card -->
                <div class="card">
                    <h2>Profile</h2>
                    <div class="profile-info">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value" id="profileName">John Doe</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="profileEmail">john@example.com</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Role:</span>
                            <span class="info-value" id="profileRole">Employee</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Department:</span>
                            <span class="info-value" id="profileDept">IT</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Today's Hours:</span>
                            <span class="info-value" id="todayHours">0h 0m</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Task</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <form id="taskForm">
                <div class="input-group">
                    <label>Task Title</label>
                    <input type="text" id="taskTitle" required>
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" id="taskDesc">
                </div>
                <div class="input-group">
                    <label>Priority</label>
                    <select id="taskPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Due Date</label>
                    <input type="date" id="taskDue">
                </div>
                <button type="submit" class="btn">Add Task</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://sizbhnyyyvbkuarulcmz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpemJobnl5eXZia3VhcnVsY216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MjcxMzQsImV4cCI6MjA3MDQwMzEzNH0.T67uwBYJp6AbaDB1CwbXh18GjvW9KwPBuyoOhniMaF0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let attendanceData = {
            isCheckedIn: false,
            isOnBreak: false,
            checkInTime: null,
            breakStart: null,
            totalBreakTime: 0
        };

        // Demo users
        const demoUsers = {
            admin: { id: 'admin_1', name: 'Admin User', email: 'admin@demo.com', role: 'admin', department: 'Management', isDemo: true },
            employee: { id: 'emp_1', name: 'John Doe', email: 'john@demo.com', role: 'employee', department: 'IT', isDemo: true }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
            setInterval(updateWorkingTime, 1000);
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('taskForm').addEventListener('submit', handleAddTask);
        }

        function checkAuth() {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                showDashboard();
                loadUserData();
                loadAttendance();
                loadTasks();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('show');
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').classList.add('show');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Get user profile
                const { data: profile } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profile) {
                    currentUser = {
                        id: profile.id,
                        name: profile.name,
                        email: profile.email,
                        role: profile.role,
                        department: profile.department,
                        isDemo: false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showNotification('Login successful!', 'success');
                    showDashboard();
                    loadUserData();
                    loadAttendance();
                    loadTasks();
                } else {
                    throw new Error('User profile not found');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed. Try demo login.', 'error');
            }
        }

        function demoLogin(type) {
            currentUser = demoUsers[type];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showNotification(`Welcome ${currentUser.name}!`, 'success');
            showDashboard();
            loadUserData();
            loadAttendance();
            loadTasks();
        }

        function logout() {
            localStorage.clear();
            currentUser = null;
            attendanceData = {
                isCheckedIn: false,
                isOnBreak: false,
                checkInTime: null,
                breakStart: null,
                totalBreakTime: 0
            };
            showNotification('Logged out', 'info');
            showLogin();
        }

        function loadUserData() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileRole').textContent = currentUser.role;
            document.getElementById('profileDept').textContent = currentUser.department;
        }

        // Attendance Functions
        function loadAttendance() {
            const saved = localStorage.getItem(`attendance_${currentUser.id}`);
            if (saved) {
                attendanceData = JSON.parse(saved);
                if (attendanceData.checkInTime) {
                    attendanceData.checkInTime = new Date(attendanceData.checkInTime);
                }
                if (attendanceData.breakStart) {
                    attendanceData.breakStart = new Date(attendanceData.breakStart);
                }
            }
            updateAttendanceUI();
        }

        function saveAttendance() {
            localStorage.setItem(`attendance_${currentUser.id}`, JSON.stringify(attendanceData));
        }

        async function checkIn() {
            try {
                attendanceData.isCheckedIn = true;
                attendanceData.checkInTime = new Date();
                
                if (!currentUser.isDemo) {
                    await supabase.from('attendance').upsert({
                        employee_id: currentUser.id,
                        date: new Date().toISOString().split('T')[0],
                        check_in: attendanceData.checkInTime.toTimeString().split(' ')[0],
                        status: 'present'
                    });
                }
                
                saveAttendance();
                updateAttendanceUI();
                showNotification('Checked in successfully!', 'success');
            } catch (error) {
                console.error('Check-in error:', error);
                showNotification('Check-in failed', 'error');
            }
        }

        async function checkOut() {
            try {
                const checkOutTime = new Date();
                const totalMs = checkOutTime - attendanceData.checkInTime - attendanceData.totalBreakTime;
                const totalHours = Math.round((totalMs / (1000 * 60 * 60)) * 100) / 100;
                
                if (!currentUser.isDemo && attendanceData.checkInTime) {
                    await supabase.from('attendance')
                        .update({
                            check_out: checkOutTime.toTimeString().split(' ')[0],
                            total_hours: totalHours,
                            break_time: Math.round(attendanceData.totalBreakTime / (1000 * 60))
                        })
                        .eq('employee_id', currentUser.id)
                        .eq('date', new Date().toISOString().split('T')[0]);
                }
                
                attendanceData = {
                    isCheckedIn: false,
                    isOnBreak: false,
                    checkInTime: null,
                    breakStart: null,
                    totalBreakTime: 0
                };
                
                saveAttendance();
                updateAttendanceUI();
                showNotification('Checked out successfully!', 'success');
            } catch (error) {
                console.error('Check-out error:', error);
                showNotification('Check-out failed', 'error');
            }
        }

        function toggleBreak() {
            if (!attendanceData.isCheckedIn) return;
            
            if (attendanceData.isOnBreak) {
                // End break
                const breakDuration = new Date() - attendanceData.breakStart;
                attendanceData.totalBreakTime += breakDuration;
                attendanceData.isOnBreak = false;
                attendanceData.breakStart = null;
                showNotification('Break ended', 'info');
            } else {
                // Start break
                attendanceData.isOnBreak = true;
                attendanceData.breakStart = new Date();
                showNotification('Break started', 'info');
            }
            
            saveAttendance();
            updateAttendanceUI();
        }

        function updateAttendanceUI() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const breakBtn = document.getElementById('breakBtn');
            const status = document.getElementById('attendanceStatus');
            const checkInTimeEl = document.getElementById('checkInTime');
            
            // Update buttons
            checkInBtn.disabled = attendanceData.isCheckedIn;
            checkOutBtn.disabled = !attendanceData.isCheckedIn;
            breakBtn.disabled = !attendanceData.isCheckedIn;
            
            if (attendanceData.isCheckedIn) {
                checkInBtn.textContent = 'Checked In';
                breakBtn.textContent = attendanceData.isOnBreak ? 'End Break' : 'Start Break';
            } else {
                checkInBtn.textContent = 'Check In';
                breakBtn.textContent = 'Break';
            }
            
            // Update status
            if (attendanceData.isCheckedIn) {
                if (attendanceData.isOnBreak) {
                    status.className = 'status-badge status-break';
                    status.textContent = 'On Break';
                } else {
                    status.className = 'status-badge status-working';
                    status.textContent = 'Working';
                }
            } else {
                status.className = 'status-badge status-out';
                status.textContent = 'Not Checked In';
            }
            
            // Update times
            if (attendanceData.checkInTime) {
                checkInTimeEl.textContent = attendanceData.checkInTime.toTimeString().substr(0, 5);
            } else {
                checkInTimeEl.textContent = '--:--';
            }
        }

        function updateWorkingTime() {
            if (attendanceData.isCheckedIn && attendanceData.checkInTime) {
                const now = new Date();
                let workingMs = now - attendanceData.checkInTime - attendanceData.totalBreakTime;
                
                if (attendanceData.isOnBreak && attendanceData.breakStart) {
                    const currentBreakMs = now - attendanceData.breakStart;
                    workingMs -= currentBreakMs;
                }
                
                const hours = Math.floor(workingMs / (1000 * 60 * 60));
                const minutes = Math.floor((workingMs % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('workingTime').textContent = `${hours}h ${minutes}m`;
                document.getElementById('todayHours').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('workingTime').textContent = '0h 0m';
                document.getElementById('todayHours').textContent = '0h 0m';
            }
        }

        // Tasks Functions
        async function loadTasks() {
            try {
                let tasks = [];
                
                if (currentUser.isDemo) {
                    const saved = localStorage.getItem(`tasks_${currentUser.id}`);
                    tasks = saved ? JSON.parse(saved) : [
                        {
                            id: 'task_1',
                            title: 'Complete project report',
                            description: 'Finish quarterly report',
                            priority: 'high',
                            due_date: '2024-08-20',
                            status: 'pending'
                        },
                        {
                            id: 'task_2',
                            title: 'Team meeting',
                            description: 'Prepare for weekly team meeting',
                            priority: 'medium',
                            due_date: '2024-08-18',
                            status: 'in_progress'
                        }
                    ];
                } else {
                    const { data } = await supabase
                        .from('tasks')
                        .select('*')
                        .eq('assigned_to', currentUser.id)
                        .order('created_at', { ascending: false });
                    tasks = data || [];
                }
                
                displayTasks(tasks);
            } catch (error) {
                console.error('Load tasks error:', error);
                displayTasks([]);
            }
        }

        function displayTasks(tasks) {
            const container = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No tasks yet. Add your first task!</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <h4>${task.title}</h4>
                    <p>${task.description || 'No description'}</p>
                    <div class="task-meta">
                        <span class="priority-${task.priority}">${task.priority.toUpperCase()}</span>
                        <span>Due: ${new Date(task.due_date).toLocaleDateString()}</span>
                        <span>${task.status}</span>
                    </div>
                </div>
            `).join('');
        }

        async function handleAddTask(e) {
            e.preventDefault();
            
            const taskData = {
                id: 'task_' + Date.now(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDesc').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDue').value,
                status: 'pending',
                assigned_to: currentUser.id,
                created_at: new Date().toISOString()
            };
            
            try {
                if (currentUser.isDemo) {
                    const saved = localStorage.getItem(`tasks_${currentUser.id}`);
                    const tasks = saved ? JSON.parse(saved) : [];
                    tasks.unshift(taskData);
                    localStorage.setItem(`tasks_${currentUser.id}`, JSON.stringify(tasks));
                } else {
                    await supabase.from('tasks').insert([taskData]);
                }
                
                closeModal();
                loadTasks();
                showNotification('Task added successfully!', 'success');
                e.target.reset();
            } catch (error) {
                console.error('Add task error:', error);
                showNotification('Failed to add task', 'error');
            }
        }

        // Modal Functions
        function openModal() {
            document.getElementById('taskModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('show');
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
